# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

Telegram –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –∫ VPN —á–µ—Ä–µ–∑ Marzban –ø–∞–Ω–µ–ª—å. –ë–æ—Ç —Å–≤—è–∑—ã–≤–∞–µ—Ç Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Ö Marzban –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ–ª—É—á–µ–Ω–∏—è subscription URL –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤).

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
pip install -r requirements.txt

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ Docker)
export $(cat .env | xargs)
python -m bot.main

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f bot

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

### Docker

```bash
# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
docker build -t marzban-telegram-bot .

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è PostgreSQL)
docker run -d --env-file .env marzban-telegram-bot
```

### CI/CD

**GitHub Actions** (`.github/workflows/docker-build.yml` - –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):
- –¢—Ä–∏–≥–≥–µ—Ä—ã: push –≤ `main` –∏–ª–∏ —Ç–µ–≥–∏ `v*`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Harbor registry (`harbor.gezzy.ru`)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ï—Å–ª–∏ workflow —Ñ–∞–π–ª–∞ –Ω–µ—Ç, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –µ–≥–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–µ–ø–ª–æ—è.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Bot Framework**: aiogram 3.13.1 (async Telegram Bot API)
- **Database ORM**: SQLAlchemy 2.0.35 (async)
- **Database Driver**: asyncpg 0.29.0
- **HTTP Client**: aiohttp 3.10.10 (–¥–ª—è Marzban API)
- **Configuration**: pydantic-settings 2.5.2
- **Python Version**: 3.11

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

```
bot/
‚îú‚îÄ‚îÄ main.py                 # Entry point, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ middleware
‚îú‚îÄ‚îÄ config.py              # Pydantic –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ .env
‚îú‚îÄ‚îÄ states.py              # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # SQLAlchemy –º–æ–¥–µ–ª–∏ (User, AdminLog, NotificationSettings, SentNotifications)
‚îÇ   ‚îî‚îÄ‚îÄ crud.py           # Database –æ–ø–µ—Ä–∞—Ü–∏–∏ (CRUD –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ marzban_api.py    # –ö–ª–∏–µ–Ω—Ç –¥–ª—è Marzban REST API
‚îÇ   ‚îî‚îÄ‚îÄ formatters.py     # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ common.py         # –û–±—â–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (/start, /help)
‚îÇ   ‚îú‚îÄ‚îÄ user.py           # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (–ø–æ–¥–ø–∏—Å–∫–∞, —Å—Å—ã–ª–∫–∞, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ user_settings.py  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ admin.py          # –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (—Å–ø–∏—Å–æ–∫, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ª–æ–≥–∏)
‚îÇ   ‚îú‚îÄ‚îÄ admin_fsm.py      # FSM —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ simple.py         # –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–æ—É—Ç–µ—Ä (legacy, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã)
‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îú‚îÄ‚îÄ user.py           # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ user_extended.py  # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ admin.py          # –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ admin_extended.py # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ simple.py         # –ë–∞–∑–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (back button, etc.)
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ database.py       # –ò–Ω–∂–µ–∫—Ç–∏—Ç AsyncSession –≤ —Ö–µ–Ω–¥–ª–µ—Ä—ã —á–µ—Ä–µ–∑ data["session"]
‚îÇ   ‚îî‚îÄ‚îÄ auth.py           # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –∏–Ω–∂–µ–∫—Ç–∏—Ç data["db_user"] –∏ data["is_admin"]
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ formatters.py     # –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã, –¥–∞—Ç—ã, emoji)
    ‚îú‚îÄ‚îÄ exceptions.py     # Custom exceptions
    ‚îî‚îÄ‚îÄ rate_limiter.py   # Rate limiting –¥–ª—è Marzban API
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–ú–æ–¥–µ–ª–∏ (SQLAlchemy 2.0 ORM):**

- `User`: –°–≤—è–∑—å –º–µ–∂–¥—É `telegram_id` –∏ `marzban_username`, —Ñ–ª–∞–≥ `is_admin`
- `AdminLog`: –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- `NotificationSettings`: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `SentNotifications`: –¢—Ä–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π

**–í–∞–∂–Ω–æ:** –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Alembic (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω), –Ω–æ —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (`create_tables()` –≤ `main.py`).

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü:** –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `create_tables(engine)` –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—ë—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ `Base.metadata.create_all()`. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Alembic –º–∏–≥—Ä–∞—Ü–∏–∏.

### Marzban API Integration

–ú–æ–¥—É–ª—å `bot/services/marzban_api.py` —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª–∞—Å—Å `MarzbanAPI` —Å –º–µ—Ç–æ–¥–∞–º–∏:

- `get_user(username)`: –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `list_users(offset, limit)`: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `create_user(username, ...)`: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Marzban
- `check_connection()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Marzban API

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** Token-based (bearer token), –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ 50 –º–∏–Ω—É—Ç.

### FSM (Finite State Machine)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ (—Ö–µ–Ω–¥–ª–µ—Ä—ã –≤ `bot/handlers/admin_fsm.py`):

- `AddUserStates`: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ RequestUser button
  - `waiting_for_user_selection` ‚Üí –≤—ã–±–æ—Ä TG –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ shared contact button
  - `waiting_for_username` ‚Üí –≤–≤–æ–¥ Marzban username
  - `waiting_for_confirmation` ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è
- `SearchUserStates`: –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ TG ID –∏–ª–∏ Marzban username
  - `waiting_for_search_query` ‚Üí –≤–≤–æ–¥ query (telegram_id –∏–ª–∏ username)

### Handler Registration

–í—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `simple_router` –≤ `bot/handlers/simple.py`:

```python
# –í main.py
dp.include_router(simple_router)

# –í bot/handlers/simple.py
simple_router = Router(name="simple")
simple_router.include_router(common_router)  # /start, /help
simple_router.include_router(user_router)    # user callbacks
simple_router.include_router(admin_router)   # admin commands/callbacks
simple_router.include_router(admin_fsm_router)  # FSM handlers
```

**Admin-only decorator:** –í—Å–µ –∞–¥–º–∏–Ω—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∑–∞—â–∏—â–µ–Ω—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º `@admin_only` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `is_admin` –∏–∑ middleware.

### Middleware

–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è middleware –≤ `main.py`:

1. **DatabaseMiddleware** (`bot/middleware/database.py`):
   - –°–æ–∑–¥–∞–µ—Ç `AsyncSession` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ update
   - –ò–Ω–∂–µ–∫—Ç–∏—Ç —á–µ—Ä–µ–∑ `data["session"]`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ—Å–ª–µ —Ö–µ–Ω–¥–ª–µ—Ä–∞

2. **AuthMiddleware** (`bot/middleware/auth.py`):
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç `User` –∏–∑ –ë–î –ø–æ `telegram_id`
   - –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ initial admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ `TELEGRAM_ADMIN_IDS`
   - –ò–Ω–∂–µ–∫—Ç–∏—Ç `data["db_user"]` (–º–æ–∂–µ—Ç –±—ã—Ç—å `None`) –∏ `data["is_admin"]` (bool)

3. **MarzbanAPI Middleware** (lambda –≤ `main.py`):
   - –ò–Ω–∂–µ–∫—Ç–∏—Ç –≥–æ—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç `MarzbanAPI` —á–µ—Ä–µ–∑ `data["marzban"]`
   - –û–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –≤–µ—Å—å lifecycle –±–æ—Ç–∞ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞)

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**

- `TELEGRAM_BOT_TOKEN`: –¢–æ–∫–µ–Ω –æ—Ç @BotFather
- `TELEGRAM_ADMIN_IDS`: Comma-separated —Å–ø–∏—Å–æ–∫ Telegram ID –∞–¥–º–∏–Ω–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ)
- `MARZBAN_API_URL`: URL Marzban –ø–∞–Ω–µ–ª–∏ (default: https://marzban.gezzy.ru)
- `MARZBAN_ADMIN_USERNAME`: Username –∞–¥–º–∏–Ω–∞ Marzban
- `MARZBAN_ADMIN_PASSWORD`: –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ Marzban
- `DATABASE_URL`: PostgreSQL connection string (—Ñ–æ—Ä–º–∞—Ç: `postgresql+asyncpg://user:pass@host:port/db`)

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:**

- `LOG_LEVEL`: –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (default: INFO)
- `SUBSCRIPTION_BASE_URL`: Base URL –¥–ª—è subscription links (default: https://marzban.gezzy.ru/sub)

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

- **üìä –ü–æ–¥–ø–∏—Å–∫–∞**: –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ (—Ç—Ä–∞—Ñ–∏–∫ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è, status emoji)
- **üîó –°—Å—ã–ª–∫–∞**: –ü–æ–ª—É—á–µ–Ω–∏–µ subscription URL –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ VPN –∫–ª–∏–µ–Ω—Ç
- **‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è**: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (V2Box, NekoBox)
- **‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏**: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏, –æ —Ç—Ä–∞—Ñ–∏–∫–µ)

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

**–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"** (—Ç–æ–ª—å–∫–æ –¥–ª—è `is_admin=True`):

- **‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**:
  - –ß–µ—Ä–µ–∑ FSM: –∫–Ω–æ–ø–∫–∞ —Å `RequestUser` ‚Üí –≤—ã–±–æ—Ä TG –∫–æ–Ω—Ç–∞–∫—Ç–∞ ‚Üí –≤–≤–æ–¥ Marzban username
  - –ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É: `/add_user <telegram_id> <marzban_username>`
  - –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –≤ Marzban –µ—Å–ª–∏ username –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (unlimited data/expire)

- **üîç –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –ü–æ–∏—Å–∫ –ø–æ Telegram ID –∏–ª–∏ Marzban username —á–µ—Ä–µ–∑ FSM
- **üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –ü–∞–≥–∏–Ω–∞—Ü–∏—è (10 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ) —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –∞–¥–º–∏–Ω–∞–º
- **üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: –°—á—ë—Ç—á–∏–∫–∏ (–≤—Å–µ–≥–æ, –∞–¥–º–∏–Ω–æ–≤, –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- **üìã –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π**: –ò—Å—Ç–æ—Ä–∏—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (add_user, make_admin, etc.)

**–ö–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ CLI**:
- `/add_user <tg_id> <username>` - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/remove_user <tg_id>` - —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/make_admin <tg_id>` - –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∞
- `/revoke_admin <tg_id>` - –∑–∞–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

**Polling vs Webhook:** –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç long polling (`dp.start_polling(bot)`), —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç development –∏ deployment –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—É–±–ª–∏—á–Ω–æ–≥–æ IP/–¥–æ–º–µ–Ω–∞.

**FSM Storage:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `MemoryStorage()` –¥–ª—è FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π. –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ FSM —Å–µ—Å—Å–∏–∏ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è `RedisStorage`.

**Database Session Management:** –ö–∞–∂–¥—ã–π update –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é `AsyncSession` —á–µ—Ä–µ–∑ middleware. Session –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ update.

**Async Architecture:** –í–µ—Å—å –∫–æ–¥ async/await –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å IO (Telegram API, Marzban API, Database).

### –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Marzban

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π `marzban_username` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Marzban, –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –µ–≥–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
- `data_limit`: Unlimited
- `expire`: Unlimited
- `status`: active
- `note`: "Created via bot for TG user {telegram_id}"

### –ù–∞—á–∞–ª—å–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ `TELEGRAM_ADMIN_IDS` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –ë–î –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –±–æ—Ç—É —Å `is_admin=True` –∏ `marzban_username=admin_{telegram_id}`.

### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–£—Ç–∏–ª–∏—Ç—ã –≤ `bot/utils/formatters.py`:

- **–¢—Ä–∞—Ñ–∏–∫**:
  - `format_bytes(bytes: int) -> str`: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±–∞–π—Ç –≤ —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç (KB/MB/GB/TB)
  - `format_progress_bar(used: int, total: int, width: int = 20) -> str`: –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (‚ñà ‚ñë) —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏

- **–î–∞—Ç—ã**:
  - `format_date_relative(dt: datetime) -> str`: –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ("—á–µ—Ä–µ–∑ 5 –¥–Ω–µ–π", "–∏—Å—Ç–µ–∫–ª–∞ 2 –¥–Ω—è –Ω–∞–∑–∞–¥")

- **–°—Ç–∞—Ç—É—Å emoji**:
  - `format_status_emoji(status, expire_dt, used_traffic, data_limit) -> str`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç üü¢ (OK) / üü° (Warning) / üî¥ (Error) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç:
    - –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Marzban
    - –û—Å—Ç–∞–≤—à–∏–π—Å—è —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (< 7 –¥–Ω–µ–π = warning)
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ (> 80% = warning, > 95% = error)

### Security

- **Non-root Docker**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `botuser` (UID 1000)
- **Multi-stage build**: –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞
- **No secrets in code**: –í—Å–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ environment variables

## Deployment –≤ Kubernetes

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω –¥–µ–ø–ª–æ—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π GitOps —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `marzban-bot-k8s` —Å ArgoCD. Deployment –≤–∫–ª—é—á–∞–µ—Ç:
- Bot Deployment
- PostgreSQL (managed –∏–ª–∏ external)
- Sealed Secrets –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è credentials
- Service/Ingress (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω webhook mode)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python
python -m py_compile bot/main.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è mypy)
mypy bot/

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ Docker Compose
docker-compose logs -f bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
docker-compose exec postgres psql -U marzban_bot -d marzban_bot

# SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: SELECT * FROM users;
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –∞–¥–º–∏–Ω–æ–≤: SELECT * FROM admin_logs ORDER BY created_at DESC LIMIT 10;
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: SELECT * FROM notification_settings;

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Marzban API
# –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —á–µ—Ä–µ–∑ check_connection()
# –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –±–æ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å sys.exit(1)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Marzban API –≤—Ä—É—á–Ω—É—é (curl)
curl -X POST "https://marzban.gezzy.ru/api/admin/token" \
  -F "username=admin" \
  -F "password=your_password"
```

## Troubleshooting

**–ë–æ—Ç –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ required –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env` —É–∫–∞–∑–∞–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PostgreSQL –∏ Marzban API
- –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: `docker-compose logs -f bot`

**–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ë–î (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `is_admin` —Ñ–ª–∞–≥ –¥–ª—è –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ middleware

**–û—à–∏–±–∫–∏ Marzban API:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `MARZBAN_API_URL` –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ credentials (`MARZBAN_ADMIN_USERNAME`, `MARZBAN_ADMIN_PASSWORD`)
- Token –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 50 –º–∏–Ω—É—Ç, –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±—É–¥–µ—Ç –Ω–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

**–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ö–µ–Ω–¥–ª–µ—Ä–∞:**
1. –°–æ–∑–¥–∞–π—Ç–µ —Ö–µ–Ω–¥–ª–µ—Ä —Ñ—É–Ω–∫—Ü–∏—é –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ñ–∞–π–ª–µ (`handlers/user.py` –∏–ª–∏ `handlers/admin.py`)
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ dependency injection –∏–∑ middleware: `session: AsyncSession`, `db_user: User | None`, `is_admin: bool`, `marzban: MarzbanAPI`
3. –î–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤ –¥–æ–±–∞–≤—å—Ç–µ `@admin_only` decorator
4. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ —Ö–µ–Ω–¥–ª–µ—Ä –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ä–æ—É—Ç–µ—Ä–µ
5. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ `keyboards/` –µ—Å–ª–∏ –Ω—É–∂–Ω–∞

**–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ –ë–î:**
1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å –≤ `bot/database/models.py` —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–π –æ—Ç `Base`
2. –î–æ–±–∞–≤—å—Ç–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ `bot/database/crud.py`
3. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Å–æ–∑–¥–∞–π—Ç–µ Alembic –º–∏–≥—Ä–∞—Ü–∏—é

**–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å FSM:**
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ `bot/states.py`
2. –°–æ–∑–¥–∞–π—Ç–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –≤ `bot/handlers/admin_fsm.py`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `state.set_state()` –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
4. –û—á–∏—â–∞–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ `state.clear()` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Marzban API:**
- –í—Å–µ –º–µ—Ç–æ–¥—ã async, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `await`
- Token –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (50 –º–∏–Ω—É—Ç)
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è `MarzbanAPIError`
- –í—Å–µ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ –≤ try/except –¥–ª—è graceful error handling
